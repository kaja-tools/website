#!/bin/bash
set -e
cd "$(dirname "$0")/.."

if [[ $(kubectl config current-context) != "kaja" ]]; then
    echo "Error: kubectl must be using kaja context"
    echo "Current context: $(kubectl config current-context)"
    exit 1
fi

# Get the first running pod with a volume mount and copy proto files
POD_NAME=$(kubectl get pods -l app=kaja --field-selector=status.phase=Running -o jsonpath='{.items[0].metadata.name}')
echo "Copying configuration and proto files to $POD_NAME"
kubectl exec $POD_NAME -- rm -rf /workspace/teams
kubectl exec $POD_NAME -- rm -rf /workspace/users
kubectl exec $POD_NAME -- mkdir /workspace/teams
kubectl exec $POD_NAME -- mkdir /workspace/users
kubectl cp apps/kaja/kaja.json $POD_NAME:/workspace/kaja.json
kubectl cp apps/teams/proto/teams.proto $POD_NAME:/workspace/teams/teams.proto
kubectl cp apps/users/proto/users.proto $POD_NAME:/workspace/users/users.proto

kubectl delete secret secrets
kubectl create secret generic secrets --from-literal=AI_API_KEY=$(cat .ai_api_key)

kubectl apply -k k8s/overlays/production

# Force fresh image pulls by adding a timestamp annotation to all deployments
DEPLOY_TIMESTAMP=$(date +%s)
echo "Forcing fresh image pulls with timestamp: $DEPLOY_TIMESTAMP"

for deployment in home-deployment kaja-deployment teams-deployment users-deployment grpc-quirks-deployment twirp-quirks-deployment; do
    kubectl patch deployment $deployment -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"deployment-timestamp\":\"$DEPLOY_TIMESTAMP\"}}}}}"
done

echo "Waiting for rollouts to complete..."
kubectl rollout status deployment home-deployment
kubectl rollout status deployment kaja-deployment
kubectl rollout status deployment teams-deployment
kubectl rollout status deployment users-deployment
kubectl rollout status deployment grpc-quirks-deployment
kubectl rollout status deployment twirp-quirks-deployment