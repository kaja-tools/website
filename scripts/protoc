#!/bin/bash
set -e

# Protoc version to use
PROTOC_VERSION="30.2"

cd "$(dirname "$0")/.."
BUILD_DIR=$PWD/build
mkdir -p "$BUILD_DIR"

# Determine OS and architecture
OS=$(uname -s)
ARCH=$(uname -m)

case "$OS" in
    Linux)
        case "$ARCH" in
            x86_64)  PROTOC_PLATFORM="linux-x86_64" ;;
            aarch64) PROTOC_PLATFORM="linux-aarch_64" ;;
            *)       echo "Unsupported Linux architecture: $ARCH"; exit 1 ;;
        esac
        ;;
    Darwin)
        case "$ARCH" in
            x86_64)  PROTOC_PLATFORM="osx-x86_64" ;;
            arm64)   PROTOC_PLATFORM="osx-aarch_64" ;;
            *)       echo "Unsupported macOS architecture: $ARCH"; exit 1 ;;
        esac
        ;;
    *)
        echo "Unsupported OS: $OS"
        exit 1
        ;;
esac

# Install protoc if not present or wrong version
PROTOC_BIN="$BUILD_DIR/bin/protoc"
if [[ ! -x "$PROTOC_BIN" ]] || ! "$PROTOC_BIN" --version 2>/dev/null | grep -q "$PROTOC_VERSION"; then
    echo "Installing protoc $PROTOC_VERSION for $PROTOC_PLATFORM..."
    PROTOC_ZIP="protoc-${PROTOC_VERSION}-${PROTOC_PLATFORM}.zip"
    PROTOC_URL="https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/${PROTOC_ZIP}"

    curl -fsSL "$PROTOC_URL" -o "$BUILD_DIR/$PROTOC_ZIP"
    unzip -o "$BUILD_DIR/$PROTOC_ZIP" -d "$BUILD_DIR"
    rm "$BUILD_DIR/$PROTOC_ZIP" "$BUILD_DIR/readme.txt"
    chmod +x "$PROTOC_BIN"
    echo "protoc $PROTOC_VERSION installed to $BUILD_DIR/bin"
fi

# Check Go is installed
if ! command -v go &> /dev/null; then
    echo "Go is not installed. Please install Go first."
    exit 1
fi

# Install Go protoc plugins into build/bin
export GOBIN=$BUILD_DIR/bin
go install github.com/twitchtv/twirp/protoc-gen-twirp@latest
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest

echo "Generating proto files..."

cd "apps/teams"
"$PROTOC_BIN" -I"$BUILD_DIR/include" --proto_path=. --plugin=protoc-gen-go="$GOBIN/protoc-gen-go" --go_out=. --plugin=protoc-gen-grpc="$GOBIN/protoc-gen-go-grpc" --grpc_out=. -Iproto/ $(find . -iname "*.proto")

cd "../users"
"$PROTOC_BIN" -I"$BUILD_DIR/include" --proto_path=. --plugin=protoc-gen-go="$GOBIN/protoc-gen-go" --go_out=. --plugin=protoc-gen-twirp="$GOBIN/protoc-gen-twirp" --twirp_out=. -Iproto/ $(find . -iname "*.proto")

cd "../quirks"
# Generate v1 proto files (exclude quirks_v2.proto which has a different go_package)
"$PROTOC_BIN" -I"$BUILD_DIR/include" --proto_path=. --plugin=protoc-gen-go="$GOBIN/protoc-gen-go" --go_out=. --plugin=protoc-gen-grpc="$GOBIN/protoc-gen-go-grpc" --grpc_out=. --plugin=protoc-gen-twirp="$GOBIN/protoc-gen-twirp" --twirp_out=. -Iproto/ $(find . -iname "*.proto" ! -name "quirks_v2.proto")

# Generate v2 proto files separately (different go_package)
"$PROTOC_BIN" -I"$BUILD_DIR/include" --proto_path=. --plugin=protoc-gen-go="$GOBIN/protoc-gen-go" --go_out=. --plugin=protoc-gen-grpc="$GOBIN/protoc-gen-go-grpc" --grpc_out=. --plugin=protoc-gen-twirp="$GOBIN/protoc-gen-twirp" --twirp_out=. -Iproto/ proto/quirks_v2.proto

echo "Proto generation complete."
